<!doctype html>
<html>
<head>
<title>Nodeny. Создание модулей услуг</title>
<meta http-equiv='Content-Type' content='text/html; charset=utf-8'>
<link rel='stylesheet' href='../i/nody.css' type='text/css'>
</head>
<body>

<div class='header'><a href='../index.html'><img src='../i/Logo.png'></a>
Создание модулей услуг</div>

<p>Услуга в NoDeny - это запись в таблице users_services, которая наделяет учетную запись клиента определенными
характеристиками, например, разрешает доступ в интернет.</p>

<p>Поле tags хранит через запятую теги, указывающие на характер действия услуги, например, стандартные:</p>

<ul>
<li>inet - разрешает доступ в интернет</li>
<li>speed - управляет скоростью доступа в интернет</li>
<li>realip - указывает выдавать клиенту реальный («белый») ip</li>
</ul>

<div class='code'><div class='mark'>Показать всех клиентов, у которых подключена услуга, дающая доступ в интернет</div>
<pre>
SELECT uid FROM users_services WHERE tags LIKE '%,inet,%';
</pre>
</div>

<p>На одну учетную запись можно активировать несколько разных услуг, например, клиент может заказать 
услугу «доступ в интернет 2 Мбит/сек», а через время «повышение скорости в 2 раза на 1 день». Эти услуги
могут сосуществовать вместе, при этом первая будет иметь теги inet и speed, а вторая только speed.</p>

<p>В таблице users_services хранятся персональные для клиента свойства услуги, а общие в таблице services.
Связь по полю service_id. В свою очередь в таблице services поле module ссылается на модуль, который
обрабатывает данный тип услуг.</p>

<p>Персональные свойства услуги: время старта услуги, время окончания услуги, теги, id услуги, которая
будет подключена после окончания текущей и id платежа, в котором происходит списание денег за услугу.</p>

<p>Услуга может быть «вечной», т.е. не иметь времени окончания, пока администратор не удалит ее. Услуга
может быть бесплатной, т.е id платежа = 0. Услуга может не иметь автопродления, т.е.
id услуги, которая будет установлена после завершения текущей, = 0.</p>

<p>Общие свойства услуги задаются в таблице services: имя, описание, группы клиентов, которые могут заказать
услугу, стоимость. Также в закодированном виде содержатся параметры, специфичные для конкретного
модуля услуг. Поскольку невозможно предусмотреть абсолютно все возможные свойства для всех услуг,
специфичные параметры хранятся в виде perl-дампа в поле param.</p>

<p>Поле module ссылается на файл, обрабатывающего услугу. Пример такого файла:</p>

<div class='code'><div class='mark'>файл /usr/local/nodeny/services/test.pm</div>
<pre>
#!/usr/bin/perl
package services::test;
use strict;

sub description
{
    return 'Услуга ничего не делает, просто снимает деньги';
}

sub tunes
{
    return [];
}

sub set_service
{
    my(undef, %p) = @_;
    my $service_new = $p{service_new};
    my $actions     = $p{actions};
    $actions->{pay} = {
        cash    =&gt; 0 - $service_new-&gt;{price},
        comment =&gt; $service_new-&gt;{description},
        category=&gt; 100,
        discount=&gt; $service_new-&gt;{discount},
    };
}

1;
</pre>
</div>

<p>Модуль услуги должен иметь такие подпрограммы:</p>
<ul>
<li>description : подсказка админу, что делает модуль. Выводится при создании услуги в админке.</li>
<li>tunes : возвращает ссылку на массив дополнительных полей.</li>
<li>set_service : возвращает список действий, которые необходимо сделать при подключении услуги.</li>
</ul>

<p>В примере подпрограмма tunes возвращает ссылку на пустой массив, т.е дополнительных полей нет. set_service
указывает сделать всего одно действие: платеж с категорией 100.</p>


<h1>Действия</h1>

<p>Подпрограмма set_service должна вернуть список действий, которые будут выполнены при подключении услуги:</p>

<ul>

<li>sql - выполнение sql запроса(ов).
<div class='code'>
<pre>
    $actions->{sql}{1} = [
        'INSERT INTO tbl SET field=?', 'xxx'
    ];
</pre>
</div>
</li>

<li>pay - создание платежа в таблице pays.
<div class='code'>
<pre>
    $actions->{pay} = {
        cash    =&gt; 10,
        comment =&gt; 'Пополнение счета на 10$',
        category=&gt; 2,
    };
</pre>
</div>
</li>

<li>set_service - услуга будет отображаться в списке подключенных услуг.
<div class='code'>
<pre>
    $actions->{set_service} = {
        period => 60*60,
        mode   => 0,
        tags   => ',x-tag,',
    };
</pre>
</div>
</li>

</ul>

<p>Здесь в массиве @$fields хранятся те специфичные параметры, о которых было сказано выше:
срок действия, входящая и исходящая скорости. В описании полей ключ type указывает на тип поля по классу Data,
например, 1 - целое положительное число. Значение value будет предложено администратору при создании услуги.</p>

<p>Метод set_service должен вернуть хеш - список действий, которые выполнит модуль services при
подключении услуги. В примере:</p>

<ul>
<li>pay - указание изменить баланс клиента и создать соответствующий платеж `снятие за услуги`;</li>
<li>set_service - создание записи с параметрами услуги.</li>
</ul>

<p>Любое из действий необязательно, однако формат конкретных действий строг.</p>


</body>
</html>
